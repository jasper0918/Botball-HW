(function(e,l){typeof define==="function"&&define.amd?define(["jquery","./log","./login","./proj_cfg","modules/common/js/miniUnderscore"],l):e.DB=l(e.$,e.LOG,e.Login,e.proj_cfg,e._)})(this,function(e,l,s,n,o){e.cookie=e.cookie||{get:function(b){b=document.cookie.match(RegExp("(^| )"+b+"=([^;]*)(;|$)"));return!b?"":decodeURIComponent(b[2])}};var p=n.DBCfg,m={},f={status:{bkn:"",baseKeyHello:true},isLoginError:false,encryptSkey:function(b){if(!b)return e.report&&e.report(45),"";for(var a=5381,c=0,d=
b.length;c<d;++c)a+=(a<<5)+b.charAt(c).charCodeAt();return a&2147483647},cgiHttp:function(b){if(b&&b.url){var a=this;b.param=b.param||{};var c,d=(new Date).getTime(),r=function(h){var g=(new Date).getTime()-d,k=(h||{}).ec,i,q;typeof k=="undefined"&&(k=999);try{IM_mmreport(b.url,k,g)}catch(u){e.mmreport(b.url,k,g)}switch(k){case 0:i=false;(b.succ||function(){})(h);break;case 1:f.isLoginError=true;l({type:"info",msg:"CGI NoLogin Error! Ec :"+k,url:b.url,mid:p.ec0_mid});a.cgiHttp.basekeytimes>=3?(i=
true,l({type:"error",msg:"basekey\u7eed\u671f\u540e, \u4ecd\u7136\u53d1\u73b0\u65e0\u767b\u9646\u6001! ",url:b.url})):b.noNeedLogin?i=true:s?s.notLoginCallback({succ:function(){b.param.bkn=a.status.bkn=a.encryptSkey(e.cookie.get("skey"));c(b.url,b.type,b.param,r)},err:function(){l({type:"error",msg:"\u65e0\u767b\u9646\u6001\u540e\u8d70\u767b\u9646\u6d41\u7a0b\u4ecd\u7136\u5931\u8d25\u4e86! ",url:b.url,mid:p.reloginFailed_mid})}}):l({type:"error",msg:"\u65e0\u767b\u9646\u6001\u540e\u5c1d\u8bd5\u8d70\u91cd\u65b0\u767b\u9646\u6d41\u7a0b,\u4f46\u672a\u627e\u5230Login\u5bf9\u8c61! ",
url:b.url});break;case 4:f.isLoginError=true;l({type:"info",msg:"CGI BaseKey Error! Ec :"+k,url:b.url,mid:p.ec4_mid});a.cgiHttp.basekeytimes>=3?(i=true,l({type:"error",msg:"basekey\u7eed\u671f\u540e, \u4ecd\u7136\u53d1\u73b0basekey\u9519\u8bef! ",url:b.url})):(a.cgiHttp.basekeytimes=(a.cgiHttp.basekeytimes||0)+1,b.param.bkn=a.status.bkn=a.encryptSkey(e.cookie.get("skey")),c(b.url,b.type,b.param,r));break;case 2:q=i=true;break;case 3:i=true;break;default:q=i=true}i&&(b.err||function(){})(h);q&&l({type:"info",
msg:"CGI Other Error! Ec :"+k,url:b.url,mid:p.ecx_mid})},h="GET",h=b.type?b.type:"POST";a.status.bkn=a.encryptSkey(e.cookie.get("skey"));b.param.bkn=a.status.bkn;b.param.src="qinfo_v2";a.cgiHttp.basekeytimes=1;c=a.helpFunction;a.helpFunction(b.url,h,b.param,r)}},helpFunction:function(b,a,c,d){e.ajax({type:a.toUpperCase(),url:b,data:c,dataType:"text",success:function(a){var c={};try{c=JSON.parse(a)}catch(f){c={},console.debug(a),l({type:"error",msg:"json.parse\u51fa\u9519\uff01cgi = "+b,url:location.href,
mid:373268})}d&&d(c)},error:function(a){var c={};try{c=JSON.parse(a)}catch(f){"string"===typeof a&&(c=eval("("+a+")")),l({type:"error",msg:"json.parse\u51fa\u9519\uff01cgi="+b,url:location.href,mid:373268})}d&&d(c)}})},ajax:function(b){this.cgiHttp({url:b.url,type:b.type,param:b.data||{},succ:b.success||function(){},err:b.error||function(){}})},api_sample:function(b){var a={};a.param=b.param||{};a.url="/cgi-bin/cgi_sample";a.succ=function(a){(b.succ||function(){})(a)};a.err=function(a){(b.err||function(){})(a)};
this.cgiHttp(a)},genSampleAPI:function(b,a){f[b]=f[b]||function(b){var d={};d.param=b.param||{};d.url="/cgi-bin/"+a;d.succ=function(a){(b.succ||function(){})(a)};d.err=function(a){(b.err||function(){})(a)};f.cgiHttp(d)}},getCgiDownloadUrl:function(b,a){if(b){var c="/cgi-bin/"+b,d;d=a||{};this.status.bkn=this.encryptSkey(e.cookie.get("skey"));d.bkn=this.status.bkn;d.src="qinfo_v2";d=e.param(d);return c+"?"+d}},isSameParam:function(b,a,c){c=c||[];b=this.delKeys(e.extend({},m[b].lastParam),c);a=this.delKeys(e.extend({},
a),c);return o.isEqual(b,a)},delKeys:function(b){for(var a in b)o.indexOf(a)!=-1&&delete b[a];return b},setConfig:function(b,a){var c={},d;for(d in b)c[d]=d in a?a[d]:b[d];return c},getCacheData:function(b){var b=m[b],a=null;if(b&&b.cacheData)a=b.cacheData;return a},setCacheData:function(){},genSampleAPI2:function(b){var a=b.cgiName,c=b.apiName;m[c]=m[c]||this.setConfig({lastParam:{},queue:[],cacheData:null,lastRequestSentTime:0,requestGotTime:0,queueTime:1E3,cacheTime:3E4},b);f[c]=f[c]||function(d){var e=
new Date-0,h={};h.param=d.param||{};h.type=b.type||"GET";h.url="/cgi-bin/"+a;var j=new Date-0,g=m[c],k=f.isSameParam(c,d.param,["useCache"]);if(!k)m[c].lastParam=o.clone(d.param);if(k&&g&&g.cacheData&&h.param.useCache!=false&&j-g.requestGotTime<=g.cacheTime)d.succ&&d.succ(g.cacheData);else{var i=window._pre_fetch_cache[a]||{};if(i.state=="waiting"&&j-i.lastRequestSentTime<=g.queueTime){g.queue.push(d);if(!i.flag)i.flag=true,g.lastRequestSentTime=i.lastRequestSentTime,window.addEventListener("message",
function(b){b=eval("("+b.data+")");switch(b.event){case "PreFetchData":if(b.cgiName==a){b=i.data||{};g.cacheData=i.data;g.requestGotTime=new Date-0;for(var c=0;c<g.queue.length;c++)b.ec==0?g.queue[c].succ&&g.queue[c].succ(b):g.queue[c].err&&g.queue[c].err(b);g.queue=[]}}});return}if(k&&j-g.lastRequestSentTime<=g.queueTime){g.queue.push(d);return}g.lastRequestSentTime=j;h.succ=function(b){g.cacheData=b;g.requestGotTime=new Date-0;for(var a=0;a<g.queue.length;a++)g.queue[a].succ&&g.queue[a].succ(b);
g.queue=[];(d.succ||function(){})(b)};h.err=function(b){for(var a=0;a<g.queue.length;a++)g.queue[a].err&&g.queue[a].err(b);g.queue=[];(d.err||function(){})(b)};f.cgiHttp(h)}e=new Date-0-e;e>1E3&&Badjs("DB genSampleAPI2:"+e,window.location,2,366176,2)};return f[c]},bkn:function(){return this.status.bkn||_this.encryptSkey(e.cookie.get("skey"))},nicks:function(b){var a={};a.param=b.param||{};a.url="/cgi-bin/qun_info/nicks";a.succ=function(a){(b.succ||function(){})(a)};a.err=function(a){(b.err||function(){})(a)};
f.cgiHttp(a)},set_group_visit_list:function(b){var a={};a.param=b.param||{};a.type="POST";a.url="/cgi-bin/qun_info/set_group_visit_list";a.succ=function(a){(b.succ||function(){})(a)};a.err=function(a){(b.err||function(){})(a)};f.cgiHttp(a)},get_group_visit_list:function(b){var a={};a.param=b.param||{};a.type="GET";a.url="/cgi-bin/qun_info/get_group_visit_list";a.succ=function(a){(b.succ||function(){})(a)};a.err=function(a){(b.err||function(){})(a)};f.cgiHttp(a)},get_group_share:function(b){var a=
{};a.param=b.param||{};a.type="GET";a.url="/cgi-bin/qun_info/get_group_share";a.succ=function(a){(b.succ||function(){})(a)};a.err=function(a){(b.err||function(){})(a)};f.cgiHttp(a)},get_group_share_download:function(b){var a={};a.param=b.param||{};a.type="GET";a.url="/cgi-bin/qun_info/get_group_share_download";a.succ=function(a){(b.succ||function(){})(a)};a.err=function(a){a.ec>=201&&a.ec<=204&&l({type:"info",msg:"CGI Other Error! get_group_share_download Ec :"+a.ec,url:"/cgi-bin/qun_info/get_group_share_download",
mid:352488});(b.err||function(){})(a)};f.cgiHttp(a)},get_group_last_photo:function(b){var a={};a.param=b.param||{};a.type="GET";a.url="/cgi-bin/qun_info/get_group_last_photo";a.succ=function(a){(b.succ||function(){})(a)};a.err=function(a){(b.err||function(){})(a)};f.cgiHttp(a)},getDBData:function(){},setDBData:function(){},_face_seq_cbk:[],_face_seq:0,_face_cbk:function(b){var a=f._face_seq_cbk[b.seq];if(b&&b.ec===0){if(b.grp){var c=b.grp,d;for(d in c){var e=c[d];if(typeof e!="string"&&typeof e==
"object"&&e.u)e=e.u,b.grp[d]=e}}a&&a.succ(b)}else a&&a.err(b)},_face_cbk_reged:false,_addFaceCbk:function(b){var a=this._face_seq;this._face_seq_cbk[this._face_seq]=b;this._face_seq++;return a},getFaces:function(b){if(b&&b.param&&!(!b.param.qq&&!b.param.grp||!b.err&&!b.succ)){var a=this,c="http://face.imweb.qq.com/cgi-bin/face?",d=[];d.push("app=group_info");d.push("redir=0");if(!a._face_cbk_reged){var f=window.callback;window.callback=function(b){f&&f(b);a._face_cbk(b)};a._face_cbk_reged=true}var h=
a._addFaceCbk({err:b.err,succ:b.succ});d.push("seq="+h);if(b.param&&b.param.qq){var j=b.param.qq,h=j.size||"40",j=j.ls.join("_");d.push("qq="+h+"|"+j)}if(b.param&&b.param.grp)h=b.param.grp,b=h.size||"40",h=h.ls.join("_"),d.push("grp="+b+"|"+h);c+=d.join("&");e.http=e.http||{};e.http.jsonp=function(a){var b=document.createElement("script");b.src=a;document.getElementsByTagName("head")[0].appendChild(b)};e.http.jsonp(c)}},_imgCache:{},getImages:function(b){for(var a=b.param&&b.param.grp&&b.param.grp.ls||
[],c=b.param&&b.param.qq&&b.param.qq.ls||[],d=function(a){var b="",c;for(c in a)b=c;return b},l=function(a,b){a.forEach(function(a){var c=d(a),a=a[c];a.onload=a.onerror=function(){this.style.visibility="visible";this.onload=this.onerror=null};a.src==b[c]?(a.style.visibility="visible",a.onload=this.onerror=null):a.src=b[c]})},h=[],j=0;j<a.length;j++)h.push({type:"grp",value:a[j]});for(j=0;j<c.length;j++)h.push({type:"qq",value:c[j]});if(h.length)if(h.length>20){c=Math.ceil(h.length/20);for(j=0;j<c;j++){for(var g=
h.splice(0,20),k={param:{},succ:b.succ,err:b.err},i=0;i<g.length;i++){a=g[i];if(a.type=="grp")!k.param.grp&&(k.param.grp={ls:[]}),k.param.grp.ls.push(a.value);if(a.type=="qq")!k.param.qq&&(k.param.qq={ls:[]}),k.param.qq.ls.push(a.value)}this.getImages(k)}}else{var m=[];if(typeof h[0].value=="object"){b=e.extend({},b);b.param.grp&&delete b.param.grp;b.param.qq&&delete b.param.qq;c=[];j=0;for(g=h.length;j<g;j++)if(k=h[j],a=k.value,i=d(a),a[i].style.visibility="hidden",this._imgCache[i])c.push(a);else{if(k.type==
"grp")!b.param.grp&&(b.param.grp={ls:[]}),b.param.grp.ls.push(i);if(k.type=="qq")!b.param.qq&&(b.param.qq={ls:[]}),b.qq.ls.push(i);m.push(a)}c.length&&l(c,this._imgCache);b.succ=function(a){l(m,e.oop.extend({},a.grp,a.qq))};b.err=function(){e.array.forEach(m,function(a){var b=d(a);a[b].style.visibility="visible"})}}f.getFaces(b)}},getSetting:function(b){var a={};a.param=b.param||{};a.type="GET";a.url="/cgi-bin/qun_info/get_group_setting";a.succ=function(a){(b.succ||function(){})(a)};a.err=function(a){(b.succ||
function(){})(a)};f.cgiHttp(a)},setOpen:function(b){var a={};a.param=b.param||{};a.type="POST";a.url="/cgi-bin/qun_info/set_open";a.succ=function(a){(b.succ||function(){})(a)};a.err=function(a){b.err?b.err(a):(b.succ||function(){})(a)};f.cgiHttp(a)},sendSms:function(b){var a={};a.param=b.param||{};a.type="POST";a.url="/cgi-bin/qun_info/send_sms";a.succ=function(a){(b.succ||function(){})(a)};a.err=function(a){(b.succ||function(){})(a)};f.cgiHttp(a)},setSearchGcOnly:function(b){var a={};a.param=b.param||
{};a.type="POST";a.url="/cgi-bin/qun_info/set_search_gc_only";a.succ=function(a){(b.succ||function(){})(a)};a.err=function(a){(b.succ||function(){})(a)};f.cgiHttp(a)},setSetting:function(b){var a={};a.param=b.param||{};a.type="POST";a.url="/cgi-bin/qun_info/set_group_setting";a.succ=function(a){(b.succ||function(){})(a)};a.err=function(a){(b.succ||function(){})(a)};f.cgiHttp(a)},checkSensitive:function(b){var a={};a.param=b.param||{};a.type="POST";a.url="/cgi-bin/qun_info/check_sensitive_word";a.succ=
function(a){(b.succ||function(){})(a)};a.err=function(a){(b.succ||function(){})(a)};f.cgiHttp(a)},getCard:function(b){var a={};a.param=b.param||{};a.type="POST";a.url="/cgi-bin/qun_info/get_group_card";a.succ=function(a){(b.succ||function(){})(a)};a.err=function(a){(b.succ||function(){})(a)};f.cgiHttp(a)},setCard:function(b){var a={},c=this;a.param=b.param||{};a.type="POST";a.url="/cgi-bin/qun_info/set_group_card";a.succ=function(d){(b.succ||function(){})(d);var d=c.getCacheData("get_group_members_all")||
c.getCacheData("get_group_members"),e=a.param.u;if(d){if(!d.cards)d.cards={};d.cards[e]=Str.encodeHtml(a.param.name)}};a.err=function(a){(b.err||function(){})(a)};f.cgiHttp(a)},setAdmin:function(b){var a={},c=this;a.param=b.param||{};a.type="POST";a.url="/cgi-bin/qun_info/set_group_admin";a.succ=function(d){(b.succ||function(){})(d);var d=c.getCacheData("get_group_members_all")||c.getCacheData("get_group_members"),d=d.adm=d.adm||[],e=a.param.op,h=Number(a.param.u),f=o.indexOf(d,h);e==1?f==-1&&d.push(h):
f!=-1&&d.splice(f,1)};a.err=function(a){(b.succ||function(){})(a)};f.cgiHttp(a)},getMembers:function(b){var a={};a.param=b.param||{};a.type="POST";a.url="/cgi-bin/qun_info/get_group_members";a.succ=function(a){(b.succ||function(){})(a)};a.err=function(a){(b.succ||function(){})(a)};f.cgiHttp(a)},getGroupMemNum:function(){var b=this.getCacheData(window.global_get_group_info);return b==null?null:b.gMemNum},delMemberFromCache:function(b){for(var a=(this.getCacheData("get_group_members_all")||this.getCacheData("get_group_members")).mems||
[],b=this.getMap(b),c=0,d=a.length;c<d;c++)b[a[c].u]&&(a.splice(c,1),c--,d--)},getMap:function(b){for(var a={},c=0,d=b.length;c<d;c++)a[b[c]]=true;return a},deleteMember:function(b){var a={};a.param=b.param||{};a.type="POST";a.url="/cgi-bin/qun_info/delete_group_member";a.succ=function(a){(b.succ||function(){})(a)};a.err=function(a){(b.succ||function(){})(a)};f.cgiHttp(a)}},n=window.global_get_group_info,t=window._pre_fetch_cache[n].data;if(t)m[n]={queue:[],cacheData:t,lastRequestSentTime:new Date-
0,requestGotTime:new Date-0,queueTime:1E3,cacheTime:3E4},window._pre_fetch_cache[n].data=null;return f});
