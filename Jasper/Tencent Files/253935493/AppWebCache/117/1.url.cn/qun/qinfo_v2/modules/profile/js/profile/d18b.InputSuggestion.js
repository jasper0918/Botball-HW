(function(c,h){typeof define==="function"&&define.amd?define(["simple","../common/util","./User","catCtrl","./searchSuggestions"],h):c.InputSuggestion=h(c.$,c.Util,c.User,c.CatCtrl,c.searchSuggestions)})(this,function(c,h,m,i,j){var k=function(){var a={pinyin:{path:"http://1.url.cn/qun/qinfo_v2/modules/profile/js/external/eb83.pinyin.js",url:"http://1.url.cn/qun/qinfo_v2/modules/profile/js/external/eb83.pinyin.js",expose:"$pinyin"}},b=typeof define==="function"&&define.amd?function(b){require([a[b].path],
function(c){a[b].m=c})}:function(b){c.http.loadScript(a[b].url,function(){a[b].m=window[a[b].expose]})};return function(c){if(c){var d=a[c];d&&!("m"in d)&&b(c);return a[c]}else{for(d in a)"m"in a[d]||b(d);return a}}}(),d=function(a,b,f){if(!d.instances)d.instances=[];d.instances.push(this);this.$ipt=a;this.type=b;this.name=a.name;this.$div=document.createElement("div");this.$div.className="select"+(f?" "+f:"");this.$ul=document.createElement("ul");this.$div.appendChild(this.$ul);this.$ipt.parentNode.appendChild(this.$div);
this.visible=false;if(b==="select")this.refreshData(),this.$ipt.setAttribute("role","combobox"),this.$ipt.setAttribute("aria-autocomplete","none"),this.$ipt.setAttribute("aria-readonly","true"),this.$ipt.setAttribute("aria-owns",this.$ipt.id+"-ul"),this.$ipt.setAttribute("aria-label","\u8bf7\u6309\u4e0a\u4e0b\u952e\u9009\u62e9,enter\u952e\u786e\u8ba4"),this.$ipt.setAttribute("readonly","true"),this.$ipt.setAttribute("tabIndex","1"),this.$ul.id=this.$ipt.id+"-ul",this.$ul.setAttribute("aria-expanded",
"false"),this.$ul.setAttribute("role","list"),this.$ul.setAttribute("tabIndex","-1"),this.keyboardHandler=function(a){var b=this,d=function(a){var d=b.keySel===void 0?-1:b.keySel,a=d+a;if(a>=0&&a<b.$ul.children.length)d>=0&&c.css.removeClass(b.$ul.children[d],"on"),c.css.addClass(b.$ul.children[a],"on"),b.keySel=a,b.$ul.children[a].setAttribute("tabIndex","1"),b.$ul.children[a].focus(),b.$ul.children[d]&&b.$ul.children[d].setAttribute("tabIndex","-1")};switch(a.keyCode){case 38:!b.visible&&b.show();
d(-1);break;case 40:!b.visible&&b.show();d(1);break;case 13:this.keySel!==void 0&&(c.e.trigger(this.$ul.children[this.keySel].firstChild,"click"),this.$ipt.focus())}},this.blurHandler=function(){this.hide();var a=this.$ul.children[this.keySel];a&&(c.css.removeClass(a,"on"),a.removeAttribute("tabIndex"));this.keySel=void 0;d.curFocusInput=null},c.e.add(a,"focus",c.oop.bind(function(){d.curFocusInput=this},this)),c.e.add(a,"click",c.oop.bind(function(a){this.dataSource.length!==0&&this.toggle(false);
a.stopPropagation()},this)),a.name==="school"&&c.e.add(a,"blur",function(){j.setValue("school",this.value)});else if(b==="select2"){if(this.refreshData(),a.setAttribute("tabIndex","1"),!a.id&&(a.id=a.name),b=c.dom.getNode("label",{"class":"element-invisible","for":this.$ipt.getAttribute("id")}),b.innerHTML=a.getAttribute("placeholder"),a.parentNode.appendChild(b),b=null,c.e.add(a,"blur",c.oop.bind(function(){if(this.$ipt.value!==""&&this.$ul.children.length>0&&this.searchMode)this.$ipt.value=this.$ul.firstChild.textContent,
this.searchMode=false,this.name==="province"&&c.oop.notifyObservers(this,"provinceChanged"),c.oop.notifyObservers(d,"fillQunDetail")},this)),c.e.add(a,"click",c.oop.bind(function(a){this.dataSource.length!==0&&(this.toggle(true),a.stopPropagation())},this)),c.e.add(a,"keyup",c.oop.bind(this.searchSource,this)),this.name==="city"){var e=d.instances.length-2;c.oop.addObserver(d.instances[e],"provinceChanged",function(){var a=d.instances[e+1];a.$ipt.value="";a.refreshData()})}}else if(b==="suggest")c.e.add(a,
"keyup",c.oop.bind(this.getSuggestions,this)),a.setAttribute("tabIndex","1"),!a.id&&(a.id=a.name),b=c.dom.getNode("label",{"class":"element-invisible","for":this.$ipt.id}),b.innerHTML=a.getAttribute("placeholder"),a.parentNode.appendChild(b),b=null;c.e.add(this.$div,"click",c.oop.bind(function(a){a.preventDefault();a.stopPropagation();if(a.target.nodeName.toLowerCase()==="a")if(a=a.target.firstChild.textContent,this._afterSelectArr)for(var b=0,f=this._afterSelectArr.length;b<f;b++)this._afterSelectArr[b].call(this,
a);else this.$ipt.value=a,this.$ipt.blur(),this.name==="school"&&j.setValue("school",a),a=this.name,(a==="building"||a==="institute"||a==="school"||a==="highSchool"||a==="elementarySchool")&&c.oop.notifyObservers(d,"fillQunDetail");this.keySel!==void 0&&c.css.removeClass(this.$ul.children[this.keySel],"on");this.keySel!==void 0&&this.$ul.children[this.keySel].setAttribute("tabIndex","-1");this.keySel=void 0;this.hide()},this));c.e.add(this.$div,"scroll",c.oop.bind(function(){console.info("onSrollInInputSuggestion");
if(this.$div.scrollTop===0)this.$div.scrollTop=1;else if(this.$div.scrollTop===this.$div.scrollHeight-this.$div.clientHeight)this.$div.scrollTop=this.$div.scrollHeight-this.$div.clientHeight-1},this));this.$ipt.inputSuggestion=this};d.hideAll=function(){d.lastShown&&d.lastShown.hide()};d.hilightLi=function(a,b){var d=b.$ul.children;d.length>0&&!b.visible&&b.show();var e=b.keySel===void 0?-1:b.keySel,g=e+a;if(g>=0&&g<d.length)e>=0&&c.css.removeClass(d[e],"on"),c.css.addClass(d[g],"on"),b.keySel=g,
d=b.$div.clientHeight,g*=24,a===-1&&g<b.$div.scrollTop?b.$div.scrollTop-=24:a===1&&g>=d+b.$div.scrollTop&&(b.$div.scrollTop+=24)};d.prototype={registerAfterOperations:function(a){if(!this._afterSelectArr)this._afterSelectArr=[];this._afterSelectArr.push(a)},refreshData:function(a){if(!a){a=i.Config.DataSource[this.$ipt.name];if(typeof a==="function")var b=c.array.indexOf(d.instances,this),a=a(d.instances[b-1]);else a=a||[];if(this.type==="select2"){var f=k("pinyin").m;if(f){var e=[],g=this.name===
"province";c.array.forEach(a,function(a){g?(i.Config.PyCache[a]===void 0&&(i.Config.PyCache[a]=f.convertPYs(a)),e.push(i.Config.PyCache[a])):e.push(f.convertPYs(a))});this.pinyinList=e}}this.dataSource=a}for(var b=[],l=0,h=a.length;l<h;l++)b.push('<li role="option" tabIndex="-1"><a href="javascript:void(0);">'+a[l]+"</a></li>");this.$ul.innerHTML=b.join("")},searchSource:function(a){var b=this;switch(a.keyCode){case 38:d.hilightLi(-1,b);break;case 40:d.hilightLi(1,b);break;case 13:if(this.keySel!==
void 0)this.$ipt.value=this.$ul.children[this.keySel].textContent,this.hide(),this.searchMode=false,this.name==="province"&&c.oop.notifyObservers(this,"provinceChanged"),c.oop.notifyObservers(d,"fillQunDetail");break;default:delete this.keySel;var f=this.$ipt.value;if(f){this.searchMode=true;var e=[];c.array.forEach(this.dataSource,function(a,c){(a.indexOf(f)!==-1||k("pinyin").m&&b.pinyinList&&(b.pinyinList[c][0].indexOf(f)!==-1||b.pinyinList[c][1].indexOf(f)!==-1))&&e.push(a)});e.length!==0&&(this.refreshData(e),
this.show())}else this.searchMode=false,this.refreshData(),this.show()}},getSuggestions:function(a){switch(a.keyCode){case 38:d.hilightLi(-1,this);break;case 40:d.hilightLi(1,this);break;case 13:if(this.keySel!==void 0)this.$ipt.value=this.$ul.children[this.keySel].textContent,this.hide(),a=this.$ipt.getAttribute("name"),(a==="building"||a==="institute"||a==="school"||a==="highSchool"||a==="elementarySchool")&&c.oop.notifyObservers(d,"fillQunDetail");break;default:delete this.keySel;var b=this.$ipt.value.replace(/\s/gm,
""),a=this.$ipt.getAttribute("name");b&&c.str.byteLen(b,3)<=this.$ipt.getAttribute("maxLength")?j.fn(i.Config.SearchTypes[a],b,this):this.hide();(a==="building"||a==="institute"||a==="school"||a==="highSchool"||a==="elementarySchool")&&c.oop.notifyObservers(d,"fillQunDetail")}},show:function(){if(d.lastShown){if(d.lastShown!==this)d.lastShown.hide(),d.lastShown=this}else d.lastShown=this,this.$div.style.display="block";this.visible=true;this.$div.scrollTop=0},hide:function(){this.$div.style.display=
"none";this.visible=false;c.css.removeClass(this.$ipt,"select-open");d.lastShown=null;delete this.keySel},toggle:function(a){if(this.visible)this.hide();else{if(a)this.searchMode=false,this.refreshData();this.show();c.css.addClass(this.$ipt,"select-open")}}};d.getDepModule=k;c.e.add(document,"keyup",function(a){var b=d.curFocusInput;if(a.keyCode===9){var c=document.activeElement;if(c&&b&&c!==b.$ipt&&c.parentNode.id!==b.$ul.id){b.blurHandler();return}}if(b&&b.type==="select")return a.stopPropagation(),
a.preventDefault(),b.keyboardHandler(a),false});return d});
