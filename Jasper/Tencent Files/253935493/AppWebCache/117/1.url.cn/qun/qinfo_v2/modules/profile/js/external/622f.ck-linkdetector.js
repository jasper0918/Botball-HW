(function(c,l){typeof define==="function"&&define.amd?define(["CKEDITOR","simple"],l):c.linkdetercotr=l(c.$)})(this,function(c,l){c.plugins.add("linkdetector",{version:0.1,init:function(j){function c(){var e=this.document.$;m=setTimeout(function(){clearTimeout(m);var a=e.body.innerHTML;if(a.match(k)){for(var o=new Date-0,a=a.replace(/(<a.+?>)|<\/a>/gi,""),g=e.getSelection(),d=g.getRangeAt(0),b=a.match(k),f=0;k.test(a);)b[f]={url:b[f],startPos:k.lastIndex-b[f].length,endPos:k.lastIndex},++f;var a=
[],h;for(h in b)b[h].url.indexOf("http://0.web.qstatic.com/")!==0&&b[h].url.indexOf("http://qplus3.idqqimg.com/")!==0&&a.push(b[h]);d.insertNode(i);d=e.body.innerHTML.replace(/(<a.+?>)|<\/a>/gi,"");h=d.indexOf(i.outerHTML);h={startPos:h,endPos:h+i.outerHTML.length,length:i.outerHTML.length};b=e.body;a:{for(f=0;f<a.length;f++){var c=a[f];if(c.startPos<h.startPos&&c.endPos+h.length>h.endPos){c.inSelection=true;c.bookmarkRange=h;f=true;break a}}f=false}b.innerHTML=f?n(d,a,true):n(d,a,h);a=e.createRange();
if(d=e.getElementById("ck-bookmark-cp"))a.selectNode(d),g.removeAllRanges(),g.addRange(a),l.dom.remove(d);console.log("linkdetector spend time :"+((new Date).getTime()-o))}},500)}function n(e,a,c){if(a.length<=0)return e;var g="";if(c===true){for(var d=0;d<a.length;d++){var b=a[d],f;f=b.url.indexOf("://")==-1?"http://"+b.url:b.url;g+=e.substring(d===0?0:a[d-1].endPos,b.startPos);b.inSelection?(c=b.url.substring(0,b.bookmarkRange.startPos-b.startPos)+i.outerHTML+b.url.substring(b.bookmarkRange.startPos-
b.startPos),g+='<a target="_blank"  href="'+f+'">'+c+"</a>"):g+='<a target="_blank"   href="'+f+'">'+b.url+"</a>"}g+=e.substring(a[a.length-1].endPos);return g}e=e.substring(0,c.startPos)+i.outerHTML+e.substring(c.endPos);for(d=0;d<a.length;d++)b=a[d],f=b.url.indexOf("://")==-1?"http://"+b.url:b.url,g+=b.startPos<c.startPos?e.substring(d===0?0:a[d-1].endPos,b.startPos):e.substring(d===0?0:a[d-1].endPos+c.length,b.startPos+c.length),g+='<a  target="_blank"   href="'+f+'">'+b.url+"</a>";g+=a[a.length-
1].startPos<c.startPos?e.substring(a[a.length-1].endPos):e.substring(a[a.length-1].endPos+c.length);return g}j.filter.allow("a[href,target]","linkdetector");var k=RegExp("((((news|telnet|nttp|file|http|ftp|https)://)|(www\\.))(([-A-Za-z0-9]+(\\.[-A-Za-z0-9]+)*(\\.[-A-Za-z]{2,5}))|([0-9]{1,3}(\\.[0-9]{1,3}){3}))(:[0-9]*)?(/[-A-Za-z0-9_\\$\\.\\+\\!\\*\\(\\),;:@&=\\?/~\\#\\%]*)*)(?![^<]*</a>)","gi"),i=document.createElement("span"),m;i.id="ck-bookmark-cp";j.on("key",function(e){e.data.keyCode==13&&c.apply(this)},
j,null,300);j.on("afterPaste",function(){c.apply(this)},j,null,300);j.on("linkDetector",function(){c.apply(this)})}})});
