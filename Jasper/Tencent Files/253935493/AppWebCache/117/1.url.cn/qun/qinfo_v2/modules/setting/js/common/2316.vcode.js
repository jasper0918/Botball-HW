define(["jquery","modules/common/js/db"],function(a,q){function r(){var c,e=function(){if(!f){var b=a("#receive_vcode");b.hasClass("disabled")||(c=a("#vcode_phone").val(),l.test(c)?(b.removeClass("btn").addClass("disabled"),f=true,q.sendSms({param:{phone:c},succ:function(e){f=false;if(e.ec===0){b.html("\u5df2\u53d1\u9001(60)");var d=60,h=function(){d<=1?b.removeClass("disabled").addClass("btn").html("\u83b7\u53d6\u9a8c\u8bc1\u7801"):(b.html("\u5df2\u53d1\u9001("+(--d<10?"0"+d:d)+")"),setTimeout(h,
1E3))};setTimeout(h,1E3);a("#vcode_phone_text").focus();i=c}else return g(e.ec==201?"\u4f60\u7684\u8bf7\u6c42\u592a\u8fc7\u9891\u7e41\u3002":"\u83b7\u53d6\u9a8c\u8bc1\u7801\u5931\u8d25\uff0c\u8bf7\u91cd\u8bd5\u3002"),b.removeClass("disabled").addClass("btn"),false}})):g("\u8bf7\u8f93\u5165\u6b63\u786e\u7684\u624b\u673a\u53f7\u7801\u3002"))}};a("#receive_vcode").bind("click",e);a("#vcode_phone").bind("keyup",function(b){b.keyCode==13&&!a("#recive_vcode").hasClass("disabled")&&e()});var h=function(){if(!f)if(i){var b=
a("#vcode_phone_text");s.test(b.val())?a.isFunction(d)&&d(b.val(),i):(g("\u9a8c\u8bc1\u7801\u8f93\u5165\u6709\u8bef\u3002"),b.focus())}else c=a("#vcode_phone").val(),l.test(c)?g("\u8bf7\u5148\u83b7\u53d6\u9a8c\u8bc1\u7801\u3002"):(g("\u624b\u673a\u53f7\u7801\u8f93\u5165\u6709\u8bef\u3002"),a("#vcode_phone").focus())};a("#vcode_phone_confirm").bind("click",h);a("#vcode_phone_text").bind("keyup",function(a){a.keyCode==13&&h()})}var f,j=false,m,i,l=/^1\d{10}$/,s=/^\d{6}$/,t=/^[a-z]{4}$/i,d,e,n,u={defaultParams:{}},
g=function(c){a(".vcode_error").html(c)},k=function(){a("#vcode_img").prop("src","http://captcha.qq.com/getimage?aid=715021421&"+(new Date).getTime());return this},p=function(){j=false;d=e=null;a("#masker").hide();a("#vcode_img_dlg,#vcode_phone_dlg").hide();o();return this},o=function(){a("#vcode_img_text").val("");a("#vcode_phone_text").val("");return this};return{init:function(c){n=a.extend({},u,c)},refreshCodeImg:k,hide:p,lock:function(){f=true;return this},unlock:function(){f=false;return this},
clear:o,isVisible:function(){return j},show:function(c,i,h){d=i;e=h;j=true;if(!m){m=true;a('<div id="masker"></div><div id="vcode_img_dlg" class="vcode_panel">                <div class="vcode_header">                    <h3 class="vcode_title">\u8bf7\u8f93\u5165\u4e0b\u56fe\u4e2d\u7684\u5b57\u7b26\uff0c\u4e0d\u533a\u5206\u5927\u5c0f\u5199</h3><a href="javascript:;" class="vcode_close_btn" title="\u5173\u95ed" tabindex="9"></a>                </div>                <ul class="vcode_ctn">                    <li><i class="adjust"></i><img id="vcode_img" class="vcode_img" title="\u9a8c\u8bc1\u7801" />                    <a id="vcode_change_img" class="change_img" href="javascript:;" tabindex="10">\u770b\u4e0d\u6e05\uff0c\u6362\u4e00\u5f20</a></li>                    <li><label for="vcode_text">\u9a8c\u8bc1\u7801\uff1a</label>                    <input id="vcode_img_text" style="ime-mode: disabled;" type="text" maxlength="4" title="\u8bf7\u8f93\u5165\u9a8c\u8bc1\u7801" tabindex="6" /></li>                </ul>                <div class="vcode_footer">                    <i class="adjust"></i><span class="vcode_error"></span>                    <a id="vcode_img_confirm" href="javascript:;" class="btn confirm"  tabindex="7">\u786e\u5b9a</a>                    <a href="javascript:;" class="btn cancel"  tabindex="8">\u53d6\u6d88</a>                </div>            </div>            <div id="vcode_phone_dlg" class="vcode_panel">                <div class="vcode_header">                    <h3 class="vcode_title">\u672c\u6b21\u64cd\u4f5c\u9700\u8981\u77ed\u4fe1\u9a8c\u8bc1\u7801\uff0c\u8bf7\u5b8c\u6210\u4ee5\u4e0b\u64cd\u4f5c</h3><a href="javascript:;" class="vcode_close_btn"  tabindex="16"></a>                </div>                <ul class="vcode_ctn">                    <li><i class="adjust"></i><input id="vcode_phone" type="text" maxlength="11" title="\u8bf7\u8f93\u5165\u624b\u673a\u53f7\u7801"  tabindex="11" />                    <a id="receive_vcode" href="javascript:;" class="btn"  tabindex="12">\u83b7\u53d6\u9a8c\u8bc1\u7801</a></li>                    <li><i class="adjust"></i><input id="vcode_phone_text" type="text" maxlength="6" title="\u8bf7\u8f93\u5165\u624b\u673a\u9a8c\u8bc1\u7801" tabindex="13" /><span>\u9a8c\u8bc1\u7801\u53ea\u80fd\u4f7f\u7528\u4e00\u6b2130\u5206\u949f\u5185\u6709\u6548</span></li>                </ul>                <div class="vcode_footer">                    <i class="adjust"></i><span class="vcode_error"></span><a id="vcode_phone_confirm" href="javascript:;" class="btn confirm"  tabindex="14">\u786e\u5b9a</a><a href="javascript:;" class="btn cancel"  tabindex="15">\u53d6\u6d88</a>                </div>            </div>').appendTo(n.parentNode||
document.body);a(".vcode_panel .vcode_close_btn, .vcode_panel .cancel").click(function(){f||(a.isFunction(e)&&e(),p())});var b=function(){if(!f){var b=a("#vcode_img_text").val();t.test(b)?a.isFunction(d)&&d(b):(g("\u9a8c\u8bc1\u7801\u8f93\u5165\u6709\u8bef\u3002"),a("#vcode_img_text").focus())}};a("#vcode_img_confirm").bind("click",b);a("#vcode_img_text").bind("keyup",function(a){a.keyCode==13&&b()});a("#vcode_img, #vcode_change_img").bind("click",k);r()}g("");c?(a("#vcode_img_dlg").show(),a("#vcode_phone_dlg").hide(),
k(),a("#vcode_img_text").focus()):(a("#vcode_phone_dlg").show(),a("#vcode_img_dlg").hide(),a("#vcode_phone").focus());a("#masker").show();a(c?"#vcode_img_dlg":"#vcode_phone_dlg").show()},showError:g}});
